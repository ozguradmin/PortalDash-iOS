name: iOS Export & Upload

on:
  push:
    branches: [ main ]
  workflow_dispatch:

env:
  GODOT_VERSION: 4.3
  EXPORT_NAME: PortalDash

jobs:
  export-ios:
    name: Export to Xcode Project
    runs-on: macos-latest

    steps:
      - name: Checkout
        uses: actions/checkout@v4.1.1
        with:
          lfs: true

      # 1. Godot Kurulumu (Manual - Robust)
      - name: Setup Godot
        run: |
          wget -q https://github.com/godotengine/godot/releases/download/${{ env.GODOT_VERSION }}-stable/Godot_v${{ env.GODOT_VERSION }}-stable_macos.universal.zip
          unzip -q Godot_v${{ env.GODOT_VERSION }}-stable_macos.universal.zip
          mv Godot.app /Applications/Godot.app
          echo "/Applications/Godot.app/Contents/MacOS" >> $GITHUB_PATH

      - name: Setup Export Templates
        run: |
          mkdir -p "$HOME/Library/Application Support/Godot/export_templates/${{ env.GODOT_VERSION }}.stable"
          wget -q https://github.com/godotengine/godot/releases/download/${{ env.GODOT_VERSION }}-stable/Godot_v${{ env.GODOT_VERSION }}-stable_export_templates.tpz
          unzip -q Godot_v${{ env.GODOT_VERSION }}-stable_export_templates.tpz
          mv templates/* "$HOME/Library/Application Support/Godot/export_templates/${{ env.GODOT_VERSION }}.stable/"
          rm -rf templates Godot_v${{ env.GODOT_VERSION }}-stable_export_templates.tpz

      - name: Install Apple Certificate and Profile
        env:
          BUILD_CERTIFICATE_BASE64: ${{ secrets.BUILD_CERTIFICATE_BASE64 }}
          P12_PASSWORD: ${{ secrets.P12_PASSWORD }}
          BUILD_PROVISION_PROFILE_BASE64: ${{ secrets.BUILD_PROVISION_PROFILE_BASE64 }}
          KEYCHAIN_PASSWORD: ${{ secrets.KEYCHAIN_PASSWORD }}
        run: |
          # Create temporary keychain
          security create-keychain -p "$KEYCHAIN_PASSWORD" build.keychain
          security default-keychain -s build.keychain
          security unlock-keychain -p "$KEYCHAIN_PASSWORD" build.keychain
          security set-keychain-settings -t 3600 -u build.keychain
          
          # Import certificate
          echo $BUILD_CERTIFICATE_BASE64 | base64 --decode > certificate.p12
          security import certificate.p12 -k build.keychain -P "$P12_PASSWORD" -T /usr/bin/codesign
          security set-key-partition-list -S apple-tool:,apple:,codesign: -s -k "$KEYCHAIN_PASSWORD" build.keychain
          
          # Install Provisioning Profile
          mkdir -p ~/Library/MobileDevice/Provisioning\ Profiles
          echo $BUILD_PROVISION_PROFILE_BASE64 | base64 --decode > profile.mobileprovision
          cp profile.mobileprovision ~/Library/MobileDevice/Provisioning\ Profiles/

      - name: Export to Xcode Project
        run: |
          mkdir -p ios_export
          # --export-release kullaniyoruz
          # || true ekledik cunku Godot build etmeye calisip patlayabilir (Sertifika yok diye)
          # Ama bizim icin onemli olan PROJE'nin olusmasi.
          godot --headless --export-release "iOS" ios_export/$EXPORT_NAME.xcodeproj || true
          
          # Eger proje klasoru olusmadiysa O ZAMAN hata verip duralim
          if [ ! -d "ios_export/$EXPORT_NAME.xcodeproj" ]; then
              echo "ERROR: Xcode project export failed."
              exit 1
          fi
          echo "Xcode project generated successfully."

      - name: Create Export Options Plist
        env:
          TEAM_ID: ${{ secrets.DEVELOPMENT_TEAM_ID }}
        run: |
          cat <<EOF > export_options.plist
          <?xml version="1.0" encoding="UTF-8"?>
          <!DOCTYPE plist PUBLIC "-//Apple//DTD PLIST 1.0//EN" "http://www.apple.com/DTDs/PropertyList-1.0.dtd">
          <plist version="1.0">
          <dict>
              <key>method</key>
              <string>app-store</string>
              <key>teamID</key>
              <string>$TEAM_ID</string>
              <key>provisioningProfiles</key>
              <dict>
                  <key>com.portaldash.game</key>
                  <string>PortalDash Distribution</string>
              </dict>
          </dict>
          </plist>
          EOF

      - name: Archive and Export IPA
        run: |
          # Archive
          xcodebuild archive \
            -project "ios_export/$EXPORT_NAME.xcodeproj" \
            -scheme "$EXPORT_NAME" \
            -archivePath "$EXPORT_NAME.xcarchive" \
            -configuration Release \
            CODE_SIGN_STYLE="Manual" \
            PROVISIONING_PROFILE_SPECIFIER="PortalDash Distribution" \
            DEVELOPMENT_TEAM="${{ secrets.DEVELOPMENT_TEAM_ID }}" \
            CODE_SIGN_IDENTITY="iPhone Distribution" \
            -allowProvisioningUpdates

          # Export IPA
          xcodebuild -exportArchive \
            -archivePath "$EXPORT_NAME.xcarchive" \
            -exportOptionsPlist export_options.plist \
            -exportPath dist/ \
            -allowProvisioningUpdates

      - name: Upload to TestFlight
        env:
          APPLE_ID: ${{ secrets.APPLE_ID }}
          APPLE_APP_SPECIFIC_PASSWORD: ${{ secrets.APPLE_APP_SPECIFIC_PASSWORD }}
        run: |
          xcrun altool --upload-app -f dist/$EXPORT_NAME.ipa -t ios -u "$APPLE_ID" -p "$APPLE_APP_SPECIFIC_PASSWORD"
          
      - name: Upload Artifact
        uses: actions/upload-artifact@v4
        with:
          name: iOS-Build
          path: dist/*.ipa